!function(e,t,n,i){e(function(){var o=e(".orr-reservation-exceptions"),r=e(".orr-reservation-exception-rows"),s=e(".orr-reservation-exception-save"),a=n.template("orr-reservation-exception-row"),d=n.template("orr-reservation-exception-row-blank"),c=Backbone.Model.extend({changes:{},logChanges:function(e){var t=this.changes||{};_.each(e,function(e,n){t[n]=_.extend(t[n]||{exception_id:n},e)}),this.changes=t,this.trigger("change:exceptions")},discardChanges:function(e){var t=this.changes||{},n=null,i=_.indexBy(this.get("exceptions"),"exception_id");t[e]&&t[e].exception_order!==undefined&&(n=t[e].exception_order),delete t[e],null!==n&&i[e]&&i[e].exception_order!==n&&(t[e]=_.extend(t[e]||{},{exception_id:e,exception_order:n})),this.changes=t,0===_.size(this.changes)&&h.clearUnloadConfirmation()},save:function(){_.size(this.changes)?e.post(i+(i.indexOf("?")>0?"&":"?")+"action=online_restaurant_reservation_exceptions_save_changes",{orr_reservation_exceptions_nonce:t.orr_reservation_exceptions_nonce,changes:this.changes},this.onSaveResponse,"json"):p.trigger("saved:exceptions")},onSaveResponse:function(e,n){"success"===n&&(e.success?(p.set("exceptions",e.data.reservation_exceptions),p.trigger("change:exceptions"),p.changes={},p.trigger("saved:exceptions")):window.alert(t.strings.save_failed))}}),l=Backbone.View.extend({rowTemplate:a,initialize:function(){this.listenTo(this.model,"change:exceptions",this.setUnloadConfirmation),this.listenTo(this.model,"saved:exceptions",this.clearUnloadConfirmation),this.listenTo(this.model,"saved:exceptions",this.render),r.on("change",{view:this},this.updateModelOnChange),r.on("sortupdate",{view:this},this.updateModelOnSort),e(window).on("beforeunload",{view:this},this.unloadConfirmation),s.on("click",{view:this},this.onSubmit),e(document.body).on("click",".orr-reservation-exception-add",{view:this},this.onAddNewRow)},block:function(){e(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){e(this.el).unblock()},render:function(){var n=_.indexBy(this.model.get("exceptions"),"exception_id"),i=this;this.$el.empty(),this.unblock(),_.size(n)?(n=_(n).chain().sortBy(function(e){return parseInt(e.exception_id,10)}).sortBy(function(e){return parseInt(e.exception_order,10)}).value(),e.each(n,function(e,n){"yes"===n.is_closed?n.closed_icon='<span class="online-restaurant-reservation-input-toggle online-restaurant-reservation-input-toggle--enabled">'+t.strings.yes+"</span>":n.closed_icon='<span class="online-restaurant-reservation-input-toggle online-restaurant-reservation-input-toggle--disabled">'+t.strings.no+"</span>",i.renderRow(n)})):i.$el.append(d),i.initRows()},renderRow:function(e){var t=this;t.$el.append(t.rowTemplate(e)),t.initRow(e)},initRow:function(t){var n=this.$el.find('tr[data-id="'+t.exception_id+'"]');e(document.body).trigger("orr-enhanced-select-init"),n.find("select").each(function(){var n=e(this).data("attribute");e(this).find('option[value="'+t[n]+'"]').prop("selected",!0),e(this).hasClass("orr-enhanced-select")&&(e(this).val(t[n]).trigger("change"),h.clearUnloadConfirmation())}),"yes"===n.data("closed")&&(n.find(".orr-enhanced-select").prop("disabled",!0),n.find(".orr-reservation-exception-time").addClass("orr-closed"));var i=n.find(".range_datepicker").datepicker({changeMonth:!0,changeYear:!0,defaultDate:"",dateFormat:"yy-mm-dd",numberOfMonths:1,minDate:0,maxDate:"+1Y",showButtonPanel:!0,showOn:"focus",buttonImageOnly:!0,onSelect:function(){var t=e(this).is(".from")?"minDate":"maxDate",n=e(this).datepicker("getDate");i.not(this).datepicker("option",t,n),i.trigger("change")}});n.find(".view").show(),n.find(".edit").hide(),n.find(".orr-reservation-exception-edit").on("click",{view:this},this.onEditRow),n.find(".orr-reservation-exception-delete").on("click",{view:this},this.onDeleteRow),n.find(".editing .orr-reservation-exception-edit").trigger("click"),n.find(".orr-reservation-exception-cancel-edit").on("click",{view:this},this.onCancelEditRow),n.find(".orr-reservation-exception-closed a").on("click",{view:this},this.onToggleClosed),n.find(".orr-exception-date-range-toggle").on("click",{view:this},this.onToggleRange),!0===t.editing&&(n.addClass("editing"),n.find(".orr-reservation-exception-edit").trigger("click"))},initRows:function(){0==e("tbody.orr-reservation-exception-rows tr").length%2?o.find("tbody.orr-reservation-exception-rows").next("tbody").find("tr").addClass("odd"):o.find("tbody.orr-reservation-exception-rows").next("tbody").find("tr").removeClass("odd"),e("#tiptip_holder").removeAttr("style"),e("#tiptip_arrow").removeAttr("style"),e(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},onSubmit:function(e){e.data.view.block(),e.data.view.model.save(),e.preventDefault()},onAddNewRow:function(n){n.preventDefault();var i=n.data.view,o=i.model,r=_.indexBy(o.get("exceptions"),"exception_id"),s={},a=_.size(r),d=_.extend({},t.default_reservation_exception,{exception_id:"new-"+a+"-"+Date.now(),editing:!0,newRow:!0});d.exception_order=1+_.max(_.pluck(r,"exception_order"),function(e){return parseInt(e,10)}),s[d.exception_id]=d,o.logChanges(s),i.renderRow(d),e(".orr-reservation-exceptions-blank-state").remove()},onEditRow:function(t){t.preventDefault(),e(this).closest("tr").addClass("editing"),e(this).closest("tr").find(".view").hide(),e(this).closest("tr").find(".edit").show(),t.data.view.model.trigger("change:exceptions")},onDeleteRow:function(t){var n=t.data.view,i=n.model,o=_.indexBy(i.get("exceptions"),"exception_id"),r={},s=e(this).closest("tr").data("id");t.preventDefault(),o[s]&&(delete o[s],r[s]=_.extend(r[s]||{},{deleted:"deleted"}),i.set("exceptions",o),i.logChanges(r)),n.render(),t.data.view.model.trigger("change:exceptions")},onCancelEditRow:function(t){var n=t.data.view,i=n.model,o=e(this).closest("tr"),r=e(this).closest("tr").data("id"),s=_.indexBy(i.get("exceptions"),"exception_id");t.preventDefault(),i.discardChanges(r),s[r]&&(s[r].editing=!1,o.after(n.rowTemplate(s[r])),n.initRow(s[r])),o.remove()},onToggleClosed:function(t){var n=t.data.view,i=e(t.target),o=n.model,r=_.indexBy(o.get("exceptions"),"exception_id"),s=i.closest("tr").data("id"),a="yes"===i.closest("tr").data("closed")?"no":"yes",d={};t.preventDefault(),r[s]&&("yes"===(a="yes"===r[s].is_closed?"no":"yes")?(e(this).closest("tr").find(".orr-enhanced-select").prop("disabled",!0),e(this).closest("tr").find(".orr-reservation-exception-time").addClass("orr-closed"),e(this).find(".online-restaurant-reservation-input-toggle").removeClass("online-restaurant-reservation-input-toggle--disabled")):(e(this).closest("tr").find(".orr-enhanced-select").prop("disabled",!1),e(this).closest("tr").find(".orr-reservation-exception-time").removeClass("orr-closed"),e(this).find(".online-restaurant-reservation-input-toggle").addClass("online-restaurant-reservation-input-toggle--disabled")),r[s].is_closed=a,d[s]=_.extend(d[s]||{},{is_closed:a}),o.set("exceptions",r),o.logChanges(d))},onToggleRange:function(){event.preventDefault();var t=e(this).closest("tr");t.find(".orr-exception-date-range").show(),t.find(".orr-exception-date-range-toggle").hide()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,s.prop("disabled",!1)},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,s.prop("disabled",!0)},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=t.strings.unload_confirmation_msg,window.event.returnValue=t.strings.unload_confirmation_msg,t.strings.unload_confirmation_msg},updateModelOnChange:function(t){var n=t.data.view.model,i=e(t.target),o=i.closest("tr").data("id"),r=i.data("attribute"),s=i.val(),a=_.indexBy(n.get("exceptions"),"exception_id"),d={};a[o]&&a[o][r]===s||("undefined"==typeof d[o]&&(d[o]={}),d[o][r]=s),n.logChanges(d)},updateModelOnSort:function(e){var t=e.data.view.model,n=_.indexBy(t.get("exceptions"),"exception_id"),i={};_.each(n,function(e){var t=parseInt(e.exception_order,10),r=parseInt(o.find('tr[data-id="'+e.exception_id+'"]').index()+1,10);t!==r&&(n[e.exception_id].exception_order=r,i[e.exception_id]=_.extend(i[e.exception_id]||{},{exception_order:r}))}),_.size(i)&&t.logChanges(i)}}),p=new c({exceptions:t.exceptions}),h=new l({model:p,el:r});h.render(),r.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.orr-reservation-exception-sort",scrollSensitivity:40})})}(jQuery,reservationExceptionsLocalizeScript,wp,ajaxurl);